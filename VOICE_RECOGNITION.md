# Voice Recognition (–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –≥–æ–ª–æ—Å–∞)

## –û–±–∑–æ—Ä

–ë–æ—Ç —Ç–µ–ø–µ—Ä—å –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π —Å –ø–æ–º–æ—â—å—é OpenAI Whisper API. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –≥–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤–º–µ—Å—Ç–æ —Ç–µ–∫—Å—Ç–∞, –∏ –±–æ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
1. –†–∞—Å–ø–æ–∑–Ω–∞–µ—Ç —Ä–µ—á—å –≤ —Ç–µ–∫—Å—Ç
2. –ü–∞—Ä—Å–∏—Ç –∑–∞–¥–∞—á—É —Å –ø–æ–º–æ—â—å—é AI
3. –°–æ–∑–¥–∞–µ—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∏–ª–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç –≤ –±—ç–∫–ª–æ–≥

## –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### 1. –û—Ç–ø—Ä–∞–≤–∫–∞ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –±–æ—Ç—É.

### 2. –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
- –ë–æ—Ç —Å–∫–∞—á–∏–≤–∞–µ—Ç –∞—É–¥–∏–æ—Ñ–∞–π–ª –≤–æ –≤—Ä–µ–º–µ–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
- –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ñ–∞–π–ª –≤ Whisper API –¥–ª—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏
- **–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç —Å –∫–Ω–æ–ø–∫–∞–º–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è**
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç:
  - ‚úÖ **–í–µ—Ä–Ω–æ** - –±–æ—Ç —Å–æ–∑–¥–∞–µ—Ç –∑–∞–¥–∞—á—É
  - ‚úèÔ∏è **–ò—Å–ø—Ä–∞–≤–∏—Ç—å** - –º–æ–∂–Ω–æ –Ω–∞–ø–∏—Å–∞—Ç—å —Ç–µ–∫—Å—Ç –∏–ª–∏ –∑–∞–ø–∏—Å–∞—Ç—å –Ω–æ–≤–æ–µ –≥–æ–ª–æ—Å–æ–≤–æ–µ

### 3. –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏
- –ü–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Ç–µ–∫—Å—Ç –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –≤ AI –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞
- –ë–æ—Ç –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∑–∞–¥–∞—á—É –∏ –≤—Ä–µ–º—è
- –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö —Å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ–º

### 3. –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

**–§–∞–π–ª**: `handlers/main.py` - —Ñ—É–Ω–∫—Ü–∏—è `voice_message_handler`

**–ü—Ä–æ—Ü–µ—Å—Å**:
```python
@router.message(F.voice)
async def voice_message_handler(message: Message):
    # 1. –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –∞—É–¥–∏–æ—Ñ–∞–π–ª–∞
    voice_file = await message.bot.get_file(message.voice.file_id)
    await message.bot.download_file(voice_file.file_path, file_path)
    
    # 2. –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Å –ø–æ–º–æ—â—å—é Whisper
    transcribed_text = await service.transcribe_voice(file_path)
    
    # 3. –ü–∞—Ä—Å–∏–Ω–≥ –∑–∞–¥–∞—á–∏ —á–µ—Ä–µ–∑ AI
    parsed = await service.parse_task_message(transcribed_text)
    
    # 4. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î
    task = await add_task(user_id, text, scheduled_time)
```

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

**OpenAI API Key** - Whisper —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –Ω–∞—Ç–∏–≤–Ω—ã–π OpenAI API.

–î–æ–±–∞–≤—å—Ç–µ –≤ `.env`:
```env
OPENAI_API_KEY=sk-your-openai-api-key-here
```

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ**: –ï—Å–ª–∏ `OPENAI_API_KEY` –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω `AI_API_KEY`, –Ω–æ —ç—Ç–æ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∫–ª—é—á OpenAI, –∞ –Ω–µ OpenRouter.

### –°—Ç–æ–∏–º–æ—Å—Ç—å

Whisper API —Å—Ç–æ–∏—Ç **$0.006 –∑–∞ –º–∏–Ω—É—Ç—É** —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è (–æ—á–µ–Ω—å –¥–µ—à–µ–≤–æ).

–°—Ä–µ–¥–Ω—è—è –≥–æ–ª–æ—Å–æ–≤–∞—è –∑–∞–º–µ—Ç–∫–∞ (10-30 —Å–µ–∫—É–Ω–¥) —Å—Ç–æ–∏—Ç ~$0.001-0.003.

## AI Service

### –ú–µ—Ç–æ–¥ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏

**–§–∞–π–ª**: `ai/service.py`

```python
async def transcribe_voice(self, audio_file_path: str) -> str:
    """
    Transcribe voice message using Whisper API.
    
    Args:
        audio_file_path: Path to audio file (ogg, mp3, etc.)
        
    Returns:
        Transcribed text from the audio
    """
    with open(audio_file_path, "rb") as audio_file:
        transcript = await self.whisper_client.audio.transcriptions.create(
            model="whisper-1",
            file=audio_file,
            language="ru"  # Russian language hint
        )
    return transcript.text.strip()
```

### –î–≤–∞ –∫–ª–∏–µ–Ω—Ç–∞ OpenAI

–°–µ—Ä–≤–∏—Å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –¥–≤–∞ –∫–ª–∏–µ–Ω—Ç–∞:
1. **self.client** - –¥–ª—è —á–∞—Ç–∞ (—á–µ—Ä–µ–∑ OpenRouter/DeepSeek)
2. **self.whisper_client** - –¥–ª—è Whisper (—Ç–æ–ª—å–∫–æ OpenAI API)

## –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã

Whisper API –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç:
- OGG (—Å—Ç–∞–Ω–¥–∞—Ä—Ç Telegram)
- MP3
- WAV
- M4A
- FLAC
- –∏ –¥—Ä—É–≥–∏–µ –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã

## –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –£—Å–ø–µ—à–Ω–æ–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ:
1. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç**: "–ù–∞–ø–æ–º–Ω–∏ –∫—É–ø–∏—Ç—å –º–æ–ª–æ–∫–æ –∑–∞–≤—Ç—Ä–∞ –≤ –¥–µ—Å—è—Ç—å —É—Ç—Ä–∞"
2. **–ë–æ—Ç —Ä–∞—Å–ø–æ–∑–Ω–∞–µ—Ç –∏ —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç**:
   ```
   üìù –†–∞—Å–ø–æ–∑–Ω–∞–ª: "–ù–∞–ø–æ–º–Ω–∏ –∫—É–ø–∏—Ç—å –º–æ–ª–æ–∫–æ –∑–∞–≤—Ç—Ä–∞ –≤ –¥–µ—Å—è—Ç—å —É—Ç—Ä–∞"
   
   –í—Å—ë –≤–µ—Ä–Ω–æ?
   [‚úÖ –í–µ—Ä–Ω–æ] [‚úèÔ∏è –ò—Å–ø—Ä–∞–≤–∏—Ç—å]
   ```
3. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç** "‚úÖ –í–µ—Ä–Ω–æ"
4. **AI –ø–∞—Ä—Å–∏—Ç**: {"task": "–ö—É–ø–∏—Ç—å –º–æ–ª–æ–∫–æ", "datetime": "2025-12-31 10:00:00"}
5. **–ë–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç**: ‚úÖ –ü–æ—Å—Ç–∞–≤–∏–ª –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –Ω–∞ 31.12.2025 –≤ 10:00

### –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å:
1. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç** "‚úèÔ∏è –ò—Å–ø—Ä–∞–≤–∏—Ç—å"
2. **–ë–æ—Ç —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç**: "‚úèÔ∏è –•–æ—Ä–æ—à–æ, –Ω–∞–ø–∏—à–∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç –∏–ª–∏ –∑–∞–ø–∏—à–∏ –Ω–æ–≤–æ–µ –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:"
3. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç**:
   - –ù–∞–ø–∏—Å–∞—Ç—å —Ç–µ–∫—Å—Ç: "–ö—É–ø–∏—Ç—å –º–æ–ª–æ–∫–æ –∑–∞–≤—Ç—Ä–∞ –≤ 10 —É—Ç—Ä–∞"
   - –ò–ª–∏ –∑–∞–ø–∏—Å–∞—Ç—å –Ω–æ–≤–æ–µ –≥–æ–ª–æ—Å–æ–≤–æ–µ (—Ü–∏–∫–ª –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è)

## –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

### –û—à–∏–±–∫–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è
–ï—Å–ª–∏ Whisper –Ω–µ —Å–º–æ–≥ —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å —Ä–µ—á—å:
```
‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑!
```

### Rate Limit
–ï—Å–ª–∏ –ø—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤:
```
‚è≥ AI —Å–µ—Ä–≤–∏—Å –≤—Ä–µ–º–µ–Ω–Ω–æ –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω.
–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥.
```

### –û–±—â–∏–µ –æ—à–∏–±–∫–∏
```
‚ùå –ù–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ.
–ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑ –∏–ª–∏ –Ω–∞–ø–∏—à–∏ —Ç–µ–∫—Å—Ç–æ–º.
```

## –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

- **–°–∫–æ—Ä–æ—Å—Ç—å**: ~1-3 —Å–µ–∫—É–Ω–¥—ã –Ω–∞ —Å—Ä–µ–¥–Ω–µ–µ –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
- **–¢–æ—á–Ω–æ—Å—Ç—å**: –û—á–µ–Ω—å –≤—ã—Å–æ–∫–∞—è –¥–ª—è —Ä—É—Å—Å–∫–æ–≥–æ —è–∑—ã–∫–∞ (Whisper –æ–±—É—á–µ–Ω –Ω–∞ —Ä—É—Å—Å–∫–æ–º)
- **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è**: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ - 25MB

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

‚úÖ –£–¥–æ–±—Å—Ç–≤–æ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π - –Ω–µ –Ω—É–∂–Ω–æ –ø–µ—á–∞—Ç–∞—Ç—å
‚úÖ –í—ã—Å–æ–∫–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ä—É—Å—Å–∫–æ–π —Ä–µ—á–∏
‚úÖ **–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ** - –º–æ–∂–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å –æ—à–∏–±–∫–∏
‚úÖ **–ì–∏–±–∫–æ—Å—Ç—å** - –º–æ–∂–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å —Ç–µ–∫—Å—Ç–æ–º –∏–ª–∏ –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å –≥–æ–ª–æ—Å–æ–º
‚úÖ –ù–∏–∑–∫–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å ($0.001-0.003 –∑–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ)
‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–∞–∫ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤—Å–µ—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤ –∞—É–¥–∏–æ

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### FSM —Å–æ—Å—Ç–æ—è–Ω–∏—è

`VoiceConfirmation.waiting_correction` - –æ–∂–∏–¥–∞–Ω–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ—Å–ª–µ –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏ "–ò—Å–ø—Ä–∞–≤–∏—Ç—å"

### –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏

1. **`voice_message_handler`** - –æ—Å–Ω–æ–≤–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
   - –†–∞—Å–ø–æ–∑–Ω–∞–µ—Ç —Ä–µ—á—å
   - –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–µ–∫—Å—Ç —Å inline-–∫–Ω–æ–ø–∫–∞–º–∏
   - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ç–µ–∫—Å—Ç –≤ FSM state

2. **`voice_confirm_callback`** - –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "‚úÖ –í–µ—Ä–Ω–æ"
   - –ü–∞—Ä—Å–∏—Ç –∑–∞–¥–∞—á—É —á–µ—Ä–µ–∑ AI
   - –°–æ–∑–¥–∞–µ—Ç –∑–∞–¥–∞—á—É –≤ –ë–î
   - –û—á–∏—â–∞–µ—Ç FSM —Å–æ—Å—Ç–æ—è–Ω–∏–µ

3. **`voice_correct_callback`** - –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "‚úèÔ∏è –ò—Å–ø—Ä–∞–≤–∏—Ç—å"
   - –ü–µ—Ä–µ–≤–æ–¥–∏—Ç –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
   - –ü—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –Ω–∞–ø–∏—Å–∞—Ç—å —Ç–µ–∫—Å—Ç –∏–ª–∏ –∑–∞–ø–∏—Å–∞—Ç—å –Ω–æ–≤–æ–µ –≥–æ–ª–æ—Å–æ–≤–æ–µ

4. **`voice_correction_text_handler`** - –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
   - –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
   - –°–æ–∑–¥–∞–µ—Ç –∑–∞–¥–∞—á—É

5. **`voice_correction_voice_handler`** - –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–æ–≤–æ–≥–æ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ
   - –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç —Ü–∏–∫–ª —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Å –Ω–æ–≤—ã–º –≥–æ–ª–æ—Å–æ–≤—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º
